name: CI

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      force_all: ${{ github.event_name == 'workflow_dispatch' }}
      run_all: ${{ steps.filter.outputs.shared == 'true' || steps.filter.outputs.tooling == 'true' || github.event_name == 'workflow_dispatch' }}
      any_unit_tests: ${{ steps.filter.outputs.create_sparkling_app == 'true' || steps.filter.outputs.sparkling_method_cli == 'true' || steps.filter.outputs.sparkling_method_sdk == 'true' || steps.filter.outputs.sparkling_router == 'true' || steps.filter.outputs.sparkling_storage == 'true' || steps.filter.outputs.playground == 'true' || steps.filter.outputs.app_template == 'true' || steps.filter.outputs.shared == 'true' || steps.filter.outputs.tooling == 'true' || github.event_name == 'workflow_dispatch' }}
      create_sparkling_app: ${{ steps.filter.outputs.create_sparkling_app }}
      sparkling_method_cli: ${{ steps.filter.outputs.sparkling_method_cli }}
      sparkling_method_sdk: ${{ steps.filter.outputs.sparkling_method_sdk }}
      sparkling_router: ${{ steps.filter.outputs.sparkling_router }}
      sparkling_storage: ${{ steps.filter.outputs.sparkling_storage }}
      playground: ${{ steps.filter.outputs.playground }}
      app_template: ${{ steps.filter.outputs.app_template }}
      shared: ${{ steps.filter.outputs.shared }}
      tooling: ${{ steps.filter.outputs.tooling }}
      changed_filters: ${{ steps.filter.outputs.changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Paths filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            create_sparkling_app:
              - 'packages/create-sparkling-app/**'
            sparkling_method_cli:
              - 'packages/sparkling-method-cli/**'
            sparkling_method_sdk:
              - 'packages/sparkling-method-sdk/**'
            sparkling_router:
              - 'packages/methods/sparkling-router/**'
            sparkling_storage:
              - 'packages/methods/sparkling-storage/**'
            playground:
              - 'packages/playground/**'
            app_template:
              - 'template/sparkling-app-template/**'
            shared:
              - 'packages/common/**'
            tooling:
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'pnpm-workspace.yaml'
              - 'tsconfig.json'
              - 'eslint.config.js'
              - '.npmrc'
              - '.prettierrc'
              - '.github/workflows/**'

  unit-tests:
    name: Unit tests (disabled)
    runs-on: ubuntu-latest
    needs: changes
    steps:
      - name: Trigger log
        run: |
          echo "event_name=${{ github.event_name }}"
          echo "actor=${{ github.actor }}"
          echo "repository=${{ github.repository }}"
          echo "workflow=${{ github.workflow }}"
          echo "ref=${{ github.ref }}"
          echo "base_ref=${{ github.base_ref }}"
          echo "head_ref=${{ github.head_ref }}"
          echo "sha=${{ github.sha }}"
          echo "run_id=${{ github.run_id }}"
          echo "run_number=${{ github.run_number }}"
          echo ""
          echo "changed_filters=${{ needs.changes.outputs.changed_filters }}"
          echo "force_all=${{ needs.changes.outputs.force_all }}"
          echo "run_all=${{ needs.changes.outputs.run_all }}"
          echo "any_unit_tests=${{ needs.changes.outputs.any_unit_tests }}"
          echo ""
          echo "create_sparkling_app=${{ needs.changes.outputs.create_sparkling_app }}"
          echo "sparkling_method_cli=${{ needs.changes.outputs.sparkling_method_cli }}"
          echo "sparkling_method_sdk=${{ needs.changes.outputs.sparkling_method_sdk }}"
          echo "sparkling_router=${{ needs.changes.outputs.sparkling_router }}"
          echo "sparkling_storage=${{ needs.changes.outputs.sparkling_storage }}"
          echo "playground=${{ needs.changes.outputs.playground }}"
          echo "app_template=${{ needs.changes.outputs.app_template }}"
          echo "shared=${{ needs.changes.outputs.shared }}"
          echo "tooling=${{ needs.changes.outputs.tooling }}"

      # NOTE: Test running config is intentionally disabled in CI.
      # Uncomment the steps below to re-enable tests.
      #
      # - name: Show change summary
      #   run: |
      #     echo "changed_filters=${{ needs.changes.outputs.changed_filters }}"
      #     echo "run_all=${{ needs.changes.outputs.run_all }}"
      #     echo "any_unit_tests=${{ needs.changes.outputs.any_unit_tests }}"
      #
      # - name: Checkout
      #   if: needs.changes.outputs.any_unit_tests == 'true'
      #   uses: actions/checkout@v4
      #
      # - name: Setup pnpm
      #   if: needs.changes.outputs.any_unit_tests == 'true'
      #   uses: pnpm/action-setup@v4
      #   with:
      #     version: 7.33.6
      #
      # - name: Setup Node.js
      #   if: needs.changes.outputs.any_unit_tests == 'true'
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: 18
      #     cache: pnpm
      #
      # - name: Install dependencies
      #   if: needs.changes.outputs.any_unit_tests == 'true'
      #   run: pnpm install --frozen-lockfile
      #
      # - name: Build sparkling-method-sdk (for router/storage tests)
      #   if: needs.changes.outputs.run_all == 'true' || needs.changes.outputs.sparkling_method_sdk == 'true' || needs.changes.outputs.sparkling_router == 'true' || needs.changes.outputs.sparkling_storage == 'true'
      #   run: pnpm --filter sparkling-method-sdk build
      #
      # - name: Test create-sparkling-app
      #   if: needs.changes.outputs.run_all == 'true' || needs.changes.outputs.create_sparkling_app == 'true'
      #   run: pnpm --filter create-sparkling-app test
      #
      # - name: Test sparkling-method-cli
      #   if: needs.changes.outputs.run_all == 'true' || needs.changes.outputs.sparkling_method_cli == 'true'
      #   run: pnpm --filter sparkling-method test
      #
      # - name: Test sparkling-router
      #   if: needs.changes.outputs.run_all == 'true' || needs.changes.outputs.sparkling_method_sdk == 'true' || needs.changes.outputs.sparkling_router == 'true'
      #   run: pnpm --filter sparkling-router test
      #
      # - name: Test sparkling-storage
      #   if: needs.changes.outputs.run_all == 'true' || needs.changes.outputs.sparkling_method_sdk == 'true' || needs.changes.outputs.sparkling_storage == 'true'
      #   run: pnpm --filter sparkling-storage test
      #
      # - name: Build playground deps (router/storage)
      #   if: needs.changes.outputs.run_all == 'true' || needs.changes.outputs.playground == 'true'
      #   run: pnpm --filter sparkling-playground^... run --if-present build
      #
      # - name: Test playground
      #   if: needs.changes.outputs.run_all == 'true' || needs.changes.outputs.playground == 'true'
      #   run: pnpm --filter sparkling-playground test
      #
      # - name: Test sparkling-app-template
      #   if: needs.changes.outputs.run_all == 'true' || needs.changes.outputs.app_template == 'true'
      #   run: pnpm --filter sparkling-app-template test
